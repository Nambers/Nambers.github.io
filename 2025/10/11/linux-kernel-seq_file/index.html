<!DOCTYPE html><html class="scroll-smooth" lang="zh-CN"> <head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1.0" name="viewport"><title>Linux Kernel seq_file 接口 • Eritque Arcus</title><link rel="icon" href="/favicon.png" type="image/png"><link href="/manifest.webmanifest" rel="manifest"><link href="https://ikuyo.dev/2025/10/11/linux-kernel-seq_file/" rel="canonical"><meta content="Linux Kernel seq_file 接口 • Eritque Arcus" name="title"><meta content="Eritque Arcus's blog" name="description"><meta content="Eritque Arcus" name="author"><meta content="article" property="og:type"><meta content="Linux Kernel seq_file 接口" property="og:title"><meta content="Eritque Arcus's blog" property="og:description"><meta content="https://ikuyo.dev/2025/10/11/linux-kernel-seq_file/" property="og:url"><meta content="Eritque Arcus" property="og:site_name"><meta content="zh_CN" property="og:locale"><meta content="1200" property="og:image:width"><meta content="630" property="og:image:height"><meta content="Eritque Arcus" property="article:author"><meta content="2025-10-11T22:01:00.000Z" property="article:published_time"><meta content="summary_large_image" property="twitter:card"><meta content="https://ikuyo.dev/2025/10/11/linux-kernel-seq_file/" property="twitter:url"><meta content="Linux Kernel seq_file 接口" property="twitter:title"><meta content="Eritque Arcus's blog" property="twitter:description"><link href="/sitemap-index.xml" rel="sitemap"><link href="/rss.xml" title="Blog" rel="alternate" type="application/rss+xml"><link href="/notes/rss.xml" title="Notes" rel="alternate" type="application/rss+xml"><link href="https://webmention.io/ikuyo.dev/webmention" rel="webmention"><meta content="Astro v5.14.4" name="generator"><link href="https://github.com/Nambers" rel="me"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="anonymous" data-unfont><link rel="preload" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?family=Major Mono Display&family=Space Grotesk&family=Noto Sans SC&family=LXGW WenKai Mono TC&display=swap" data-unfont><style>@font-face{font-family:Maple Mono;font-style:normal;font-display:swap;font-weight:400;src:url(/_astro/maple-mono-latin-400-normal.C5QbKxa2.woff2) format("woff2"),url(/_astro/maple-mono-latin-400-normal.BgUYpi45.woff) format("woff")}
</style>
<link rel="stylesheet" href="/_astro/_page_.Qxx8qG3y.css"><script type="module" src="/_astro/page.CwTOY3h6.js"></script></head> <body class="bg-global-bg text-global-text mx-auto flex min-h-screen max-w-7xl flex-col px-4 pt-16 text-sm font-normal antialiased sm:px-8"> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "light" : "dark");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "light" : "dark"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-28 flex w-full items-center sm:ps-20" id="main-header"> <div class="flex w-full sm:flex-col"> <div class="flex w-full items-center sm:relative sm:inline-block"> <a aria-current="false" class="inline-flex items-center sm:relative sm:inline-block" href="/"> <img src="/avatar.png" alt="Avatar" class="me-3 h-16 w-16 rounded-full sm:absolute sm:-start-18 sm:me-0 sm:h-16 sm:w-16"> <span class="font-display text-accent ps-3 text-4xl font-bold tracking-wide whitespace-nowrap dark:drop-shadow-[0_0_2px_white] dark:drop-shadow-[0_0_4px_cyan] dark:drop-shadow-[0_0_8px_cyan] dark:drop-shadow-[0_0_16px_rgba(0,255,255,0.5)]"> Eritque Arcus </span> </a> </div> <nav aria-label="Main menu" class="bg-global-bg/85 absolute -inset-x-4 top-14 hidden w-full flex-col items-end gap-y-4 rounded-md py-4 shadow backdrop-blur-sm group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:rounded-none sm:bg-transparent sm:py-0 sm:ps-4 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <div class="text-accent sm:divide-accent sm:divide-x"> <a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/archive/"> Archive </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/about/"> About </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/math-notes/"> Notes </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/ctf-cheatsheet/"> CTF-QuickRef </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/music/"> Music </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="https://photos.ikuyo.dev"> Photos </a> </div> <div class="flex sm:ps-28"> <site-search class="ms-auto" id="search"> <button class="hover:text-accent flex h-9 w-9 cursor-pointer items-center justify-center rounded-md" aria-keyshortcuts="Control+K Meta+K" data-open-modal disabled> <svg aria-hidden="true" class="h-7 w-7" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" stroke="none"></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path> </svg> <span class="sr-only">Open Search</span> </button> <dialog aria-label="search" class="bg-global-bg h-full max-h-full w-full max-w-full border border-zinc-400 shadow-sm backdrop:backdrop-blur-sm open:flex sm:mx-auto sm:mt-16 sm:mb-auto sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md"> <div class="dialog-frame flex grow flex-col gap-4 p-6 pt-12 sm:pt-6"> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal>Close</button> <div class="search-container"> <div id="cactus__search"></div> </div> </div> </dialog> </site-search> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.rgeqRwRC.js"></script> <theme-toggle class="ms-2 sm:ms-4"> <button class="hover:text-accent relative h-9 w-9 cursor-pointer rounded-md p-2" type="button"> <span class="sr-only">Dark Theme</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0" fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100" fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path> <path d="M19 11h2m-1 -1v2"></path> </svg> </button> </theme-toggle> <script type="module" src="/_astro/ThemeToggle.astro_astro_type_script_index_0_lang.C1tldoqx.js"></script> </div> </nav> </div> <mobile-button class="mb-15"> <button aria-expanded="false" aria-haspopup="menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <span class="sr-only">Open main menu</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="text-accent absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header> <script type="module" src="/_astro/Header.astro_astro_type_script_index_0_lang.DuSsDY4R.js"></script> <main id="main">  <article class="grow break-words" data-pagefind-body> <div id="blog-hero" class="mb-12"><h1 class="title"> Linux Kernel seq_file 接口 </h1> <div class="flex flex-wrap items-center gap-x-3 gap-y-2"> <p class="font-semibold"> <time datetime="2025-10-11T22:01:00.000Z" title="2025-10-11T22:01:00.000Z">11 October 2025</time> /  9 min read </p>  </div> <div class="mt-2"> <svg aria-hidden="true" class="inline-block h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> <span class="contents"> <a class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag:linux kernel" href="/tags/linux kernel/"><span class="sr-only">View more blogs with the tag&nbsp;</span>linux kernel </a> </span>  </div></div> <div class="grid grid-cols-[1fr_auto] gap-10 lg:flex-row lg:items-start"> <details open class="lg:sticky lg:top-12 lg:order-2 lg:-me-32 lg:basis-64"> <summary class="title hover:marker:text-accent cursor-pointer text-lg">Table of Contents</summary> <nav class="ms-4 lg:w-full"> <ol class="mt-4"> <li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#tldr"><span aria-hidden="true" class="me-0.5">#</span>TL;DR</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#数据结构"><span aria-hidden="true" class="me-0.5">#</span>数据结构</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#helpers"><span aria-hidden="true" class="me-0.5">#</span>Helpers</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#open"><span aria-hidden="true" class="me-0.5">#</span>Open</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#read"><span aria-hidden="true" class="me-0.5">#</span>Read</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#more-ref"><span aria-hidden="true" class="me-0.5">#</span>more ref</a>  </li> </ol> </nav> </details> <div class="prose max-w-none prose-base prose-code:font-normal prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-gray-600 prose-headings:hover:before:text-accent sm:prose-headings:before:content-['#'] sm:prose-th:before:content-none">  <h2 id="tldr"><a class="not-prose" href="#tldr">TL;DR</a></h2>
<p><code>seq_file</code> 在内核里如果需要传输列表类型的数据还是比较好用的, 比如 <code>show_fiq_list</code>, <code>show_cache_info</code> 之类的. 实现基本是每一个 fd 都创建一个不定长 buffer, 每次优先读取缓存内容然后用 item 级别更新缓存来确保不会出现格式或者数据问题. 为数不多的缺点可能在于锁和对写操作的缺乏支持 --- 因为在设计的时候就认为为只在最开始写入一次.</p>
<blockquote>
<p>Linux Kernel <code>6.17.1</code><br>
文件名和初始行号符合内核文件, 但是后面的行号可能会因为额外注释偏移</p>
</blockquote>
<h2 id="数据结构"><a class="not-prose" href="#数据结构">数据结构</a></h2>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.oaceo.css"><script type="module" src="/_astro/ec.p1z7b.js"></script><figure class="frame has-title"><figcaption class="header"><span class="title">include/linux/seq_file.h</span></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:73ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_operations;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file {</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// buffer</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">char</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">buf;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// buffer size</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> size;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// remaining start</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> from;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// remaining size</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> count;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> pad_until;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// last show index in list</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> index;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// last fd read_pos</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> read_pos;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// fd thread-safe guard</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> mutex lock;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">const</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_operations </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">op;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> poll_event;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">const</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">file;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// preserve data pointer to any data we want to store</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">private;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">};</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_operations {</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// setup seq_file with index, return the item pointer</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// e.g. we can lock write lock and find the item by index(named pos)</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">start) (</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">m, </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">pos);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// finish/cleanup seq_file feeding with given item</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// e.g. we can unlock write lock</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">stop) (</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">m, </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">v);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// roll to next item in list given pos and last item, return new item</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// e.g. go throught next pointer and update last_pos</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">next) (</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">m, </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">v, </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">pos);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// dump item pointer to buffer in seq_file</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// e.g. snprintf or memcpy and update count/size</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">show) (</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">m, </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">v);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">};</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="struct seq_operations;struct seq_file {    // buffer    char *buf;    // buffer size    size_t size;    // remaining start    size_t from;    // remaining size    size_t count;    size_t pad_until;    // last show index in list    loff_t index;    // last fd read_pos    loff_t read_pos;    // fd thread-safe guard    struct mutex lock;    const struct seq_operations *op;    int poll_event;    const struct file *file;    // preserve data pointer to any data we want to store    void *private;};struct seq_operations {    // setup seq_file with index, return the item pointer    // e.g. we can lock write lock and find the item by index(named pos)    void * (*start) (struct seq_file *m, loff_t *pos);    // finish/cleanup seq_file feeding with given item    // e.g. we can unlock write lock    void (*stop) (struct seq_file *m, void *v);    // roll to next item in list given pos and last item, return new item    // e.g. go throught next pointer and update last_pos    void * (*next) (struct seq_file *m, void *v, loff_t *pos);    // dump item pointer to buffer in seq_file    // e.g. snprintf or memcpy and update count/size    int (*show) (struct seq_file *m, void *v);};"><div></div></button></div></figure></div>
<h2 id="helpers"><a class="not-prose" href="#helpers">Helpers</a></h2>
<p>判断如果目前 <code>buffer</code> 已经满或溢出(需要 <code>realloc</code> 一个更大的 <code>buffer</code>)</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">include/linux/seq_file.h</span></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:73ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">/**</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* seq_has_overflowed - check if the buffer has overflowed</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* </span><span style="--0:#F97583;--1:#BF3441">@m:</span><span style="--0:#99A0A6;--1:#616972"> the seq_file handle</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* seq_files have a buffer which may overflow. When this happens a larger</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* buffer is reallocated and all the data will be printed again.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* The overflow state is true when m->count == m->size.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* Returns true if the buffer received more than it can hold.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">static</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">inline</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">bool</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_has_overflowed</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">m</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> m->count </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> m->size;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">53</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * seq_has_overflowed - check if the buffer has overflowed * @m: the seq_file handle * * seq_files have a buffer which may overflow. When this happens a larger * buffer is reallocated and all the data will be printed again. * The overflow state is true when m->count == m->size. * * Returns true if the buffer received more than it can hold. */static inline bool seq_has_overflowed(struct seq_file *m){    return m->count == m->size;}"><div></div></button></div></figure></div>
<p>从 <code>addr</code> 复制 <code>iov</code> 里要求的大小</p>
<div class="expressive-code"><figure class="frame has-title" style="--lnWidth:3ch"><figcaption class="header"><span class="title">include/linux/uio.h</span></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:71ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">216</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">static</span><span style="--0:#E1E4E8;--1:#24292E"> __always_inline __must_check</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">217</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">copy_to_iter</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">const</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">addr</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">bytes</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> iov_iter </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">i</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">218</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">219</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">check_copy_size</span><span style="--0:#E1E4E8;--1:#24292E">(addr, bytes, </span><span style="--0:#79B8FF;--1:#005CC5">true</span><span style="--0:#E1E4E8;--1:#24292E">))</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">220</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">_copy_to_iter</span><span style="--0:#E1E4E8;--1:#24292E">(addr, bytes, i);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">221</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">222</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="static __always_inline __must_checksize_t copy_to_iter(const void *addr, size_t bytes, struct iov_iter *i){    if (check_copy_size(addr, bytes, true))        return _copy_to_iter(addr, bytes, i);    return 0;}"><div></div></button></div></figure></div>
<p>从 <code>seq_file</code> 里重新找到指定的偏移量</p>
<div class="expressive-code"><figure class="frame has-title" style="--lnWidth:3ch"><figcaption class="header"><span class="title">fs/seq_file.c</span></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:82ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">90</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">static</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">traverse</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">m</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">offset</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">91</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">92</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> pos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">93</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> error </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">94</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">p;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">95</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">96</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->index </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">97</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->from </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">98</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">offset)</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">99</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">100</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">101</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">102</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// init default size buffer</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">103</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->buf </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_buf_alloc</span><span style="--0:#E1E4E8;--1:#24292E">(m->size </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> PAGE_SIZE);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">104</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">105</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">ENOMEM;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">106</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">107</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// start with given index</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">108</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">start</span><span style="--0:#E1E4E8;--1:#24292E">(m, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">109</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> (p) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">110</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">error </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">PTR_ERR</span><span style="--0:#E1E4E8;--1:#24292E">(p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">111</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">IS_ERR</span><span style="--0:#E1E4E8;--1:#24292E">(p))</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">112</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">113</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// dump current item</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">114</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">error </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">show</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">115</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (error </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">116</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">117</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">unlikely</span><span style="--0:#E1E4E8;--1:#24292E">(error)) {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">118</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">error </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">119</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">120</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">121</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">seq_has_overflowed</span><span style="--0:#E1E4E8;--1:#24292E">(m))</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">122</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Eoverflow;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">123</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// go next item</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">124</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">next</span><span style="--0:#E1E4E8;--1:#24292E">(m, p, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">125</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// if current buffer exceed required offset</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">126</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// update from and buffer remaining count</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">127</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (pos </span><span style="--0:#F97583;--1:#BF3441">+</span><span style="--0:#E1E4E8;--1:#24292E"> m->count </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> offset) {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">128</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->from </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> offset </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E"> pos;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">129</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">-=</span><span style="--0:#E1E4E8;--1:#24292E"> m->from;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">130</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">131</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">132</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// otherwise just keep iterate till it reached</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">133</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">pos </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> m->count;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">134</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// update buffer remaining size to zero caused it's before required offset</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">135</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">136</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// if reached/perfect match</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">137</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (pos </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> offset)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">138</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">139</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">140</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// cleanup</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">141</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op-></span><span style="--0:#B392F0;--1:#6F42C1">stop</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">142</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> error;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">143</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">144</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">Eoverflow:</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">145</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op-></span><span style="--0:#B392F0;--1:#6F42C1">stop</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">146</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">kvfree</span><span style="--0:#E1E4E8;--1:#24292E">(m->buf);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">147</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">148</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// if overflow get bigger buffer and redo the process</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">149</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->buf </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_buf_alloc</span><span style="--0:#E1E4E8;--1:#24292E">(m->size </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">150</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf </span><span style="--0:#F97583;--1:#BF3441">?</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">ENOMEM </span><span style="--0:#F97583;--1:#BF3441">:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">EAGAIN;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">151</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="static int traverse(struct seq_file *m, loff_t offset){    loff_t pos = 0;    int error = 0;    void *p;    m->index = 0;    m->count = m->from = 0;    if (!offset)        return 0;    if (!m->buf) {        // init default size buffer        m->buf = seq_buf_alloc(m->size = PAGE_SIZE);        if (!m->buf)            return -ENOMEM;    }    // start with given index    p = m->op->start(m, &#x26;m->index);    while (p) {        error = PTR_ERR(p);        if (IS_ERR(p))            break;        // dump current item        error = m->op->show(m, p);        if (error < 0)            break;        if (unlikely(error)) {            error = 0;            m->count = 0;        }        if (seq_has_overflowed(m))            goto Eoverflow;        // go next item        p = m->op->next(m, p, &#x26;m->index);        // if current buffer exceed required offset        // update from and buffer remaining count        if (pos + m->count > offset) {            m->from = offset - pos;            m->count -= m->from;            break;        }        // otherwise just keep iterate till it reached        pos += m->count;        // update buffer remaining size to zero caused it&#x27;s before required offset        m->count = 0;        // if reached/perfect match        if (pos == offset)            break;    }    // cleanup    m->op->stop(m, p);    return error;Eoverflow:    m->op->stop(m, p);    kvfree(m->buf);    m->count = 0;    // if overflow get bigger buffer and redo the process    m->buf = seq_buf_alloc(m->size <<= 1);    return !m->buf ? -ENOMEM : -EAGAIN;}"><div></div></button></div></figure></div>
<h2 id="open"><a class="not-prose" href="#open">Open</a></h2>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">fs/seq_file.c</span></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:75ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">/**</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  seq_open -  initialize sequential file</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@file</span><span style="--0:#99A0A6;--1:#616972">: file we initialize</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@op:</span><span style="--0:#99A0A6;--1:#616972"> method table describing the sequence</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  seq_open() sets </span><span style="--0:#F97583;--1:#BF3441">@file</span><span style="--0:#99A0A6;--1:#616972">, associating it with a sequence described</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  by @op.  @op->start() sets the iterator up and returns the first</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  element of sequence. @op->stop() shuts it down.  @op->next()</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  returns the next element of sequence.  @op->show() prints element</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  into the buffer.  In case of error ->start() and ->next() return</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  ERR_PTR(error).  In the end of sequence they return %NULL. ->show()</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  returns 0 in case of success and negative number in case of error.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">53</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  Returning SEQ_SKIP means "discard this element and move on".</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">54</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  Note: seq_open() will allocate a struct seq_file and store its</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">55</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  pointer in </span><span style="--0:#F97583;--1:#BF3441">@file</span><span style="--0:#99A0A6;--1:#616972">->private_data. This pointer should not be modified.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">56</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">57</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_open</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">file</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">const</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_operations </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">op</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">58</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">59</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">p;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">60</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">61</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">WARN_ON</span><span style="--0:#E1E4E8;--1:#24292E">(file->private_data);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">62</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">63</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">kmem_cache_zalloc</span><span style="--0:#E1E4E8;--1:#24292E">(seq_file_cache, GFP_KERNEL);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">64</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">p)</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">65</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">ENOMEM;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">66</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">67</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// set private data to seq_file struct</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">68</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">file->private_data </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">69</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">70</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">mutex_init</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">p->lock);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">71</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">p->op </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> op;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">72</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">73</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// No refcounting: the lifetime of 'p' is constrained</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">74</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// to the lifetime of the file.</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">75</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">p->file </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> file;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">76</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">77</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">    </span></span><span style="--0:#99A0A6;--1:#616972">/*</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">78</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* seq_files support lseek() and pread().  They do not implement</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">79</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* write() at all, but we clear FMODE_PWRITE here for historical</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">80</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* reasons.</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">81</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">*</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">82</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* If a client of seq_files a) implements file.write() and b) wishes to</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">83</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* support pwrite() then that client will need to implement its own</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">84</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* file.open() which calls seq_open() and then sets FMODE_PWRITE.</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">85</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">86</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">file->f_mode </span><span style="--0:#F97583;--1:#BF3441">&#x26;=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">~</span><span style="--0:#E1E4E8;--1:#24292E">FMODE_PWRITE;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">87</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">88</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">89</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">EXPORT_SYMBOL</span><span style="--0:#E1E4E8;--1:#24292E">(seq_open);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** *  seq_open -  initialize sequential file *  @file: file we initialize *  @op: method table describing the sequence * *  seq_open() sets @file, associating it with a sequence described *  by @op.  @op->start() sets the iterator up and returns the first *  element of sequence. @op->stop() shuts it down.  @op->next() *  returns the next element of sequence.  @op->show() prints element *  into the buffer.  In case of error ->start() and ->next() return *  ERR_PTR(error).  In the end of sequence they return %NULL. ->show() *  returns 0 in case of success and negative number in case of error. *  Returning SEQ_SKIP means &#x22;discard this element and move on&#x22;. *  Note: seq_open() will allocate a struct seq_file and store its *  pointer in @file->private_data. This pointer should not be modified. */int seq_open(struct file *file, const struct seq_operations *op){    struct seq_file *p;    WARN_ON(file->private_data);    p = kmem_cache_zalloc(seq_file_cache, GFP_KERNEL);    if (!p)        return -ENOMEM;    // set private data to seq_file struct    file->private_data = p;    mutex_init(&#x26;p->lock);    p->op = op;    // No refcounting: the lifetime of &#x27;p&#x27; is constrained    // to the lifetime of the file.    p->file = file;    /*     * seq_files support lseek() and pread().  They do not implement     * write() at all, but we clear FMODE_PWRITE here for historical     * reasons.     *     * If a client of seq_files a) implements file.write() and b) wishes to     * support pwrite() then that client will need to implement its own     * file.open() which calls seq_open() and then sets FMODE_PWRITE.     */    file->f_mode &#x26;= ~FMODE_PWRITE;    return 0;}EXPORT_SYMBOL(seq_open);"><div></div></button></div></figure></div>
<p>里面值得注意的是最后把文件的 <code>write</code> 标志强制取消了.</p>
<h2 id="read"><a class="not-prose" href="#read">Read</a></h2>
<div class="expressive-code"><figure class="frame" style="--lnWidth:3ch"><figcaption class="header"></figcaption><pre data-language="c" class="wrap" style="--ecMaxLine:91ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">/**</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  seq_read -  ->read() method for sequential files.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@file</span><span style="--0:#99A0A6;--1:#616972">: the file to read from</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@buf:</span><span style="--0:#99A0A6;--1:#616972"> the buffer to read to</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@size:</span><span style="--0:#99A0A6;--1:#616972"> the maximum number of bytes to read</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  </span><span style="--0:#F97583;--1:#BF3441">@ppos:</span><span style="--0:#99A0A6;--1:#616972"> the current position in the file</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*  Ready-made ->f_op->read()</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">10</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">ssize_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_read</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">file</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">char</span><span style="--0:#E1E4E8;--1:#24292E"> __user </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">buf</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#FFAB70;--1:#AE4B07">size</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">ppos</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">11</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">12</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// construct a iov request from one-time read</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">13</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> iovec iov </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> { .iov_base </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> buf, .iov_len </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> size};</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">14</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> kiocb kiocb;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">15</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> iov_iter iter;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">16</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">ssize_t</span><span style="--0:#E1E4E8;--1:#24292E"> ret;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">17</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">18</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">init_sync_kiocb</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">kiocb, file);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">19</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">iov_iter_init</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">iter, ITER_DEST, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">iov, </span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">, size);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">20</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">21</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">kiocb.ki_pos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">ppos;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">22</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// enter real read function</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">23</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">ret </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_read_iter</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">kiocb, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">iter);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">24</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">ppos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> kiocb.ki_pos;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">25</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> ret;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">26</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">27</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">EXPORT_SYMBOL</span><span style="--0:#E1E4E8;--1:#24292E">(seq_read);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">28</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">29</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">/*</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">30</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">* Ready-made ->f_op->read_iter()</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">31</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972"> </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">32</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">ssize_t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_read_iter</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> kiocb </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">iocb</span><span style="--0:#E1E4E8;--1:#24292E">, </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> iov_iter </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#FFAB70;--1:#AE4B07">iter</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">33</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">{</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">34</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">struct</span><span style="--0:#E1E4E8;--1:#24292E"> seq_file </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">m </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> iocb->ki_filp->private_data;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">35</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> copied </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">36</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">37</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">void</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">*</span><span style="--0:#E1E4E8;--1:#24292E">p;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">38</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">int</span><span style="--0:#E1E4E8;--1:#24292E"> err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">39</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">40</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// if request to read 0 byte</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">41</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#B392F0;--1:#6F42C1">iov_iter_count</span><span style="--0:#E1E4E8;--1:#24292E">(iter))</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">42</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">43</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">44</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// make sure only one thread enter</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">45</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">mutex_lock</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->lock);</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">46</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">47</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">    </span></span><span style="--0:#99A0A6;--1:#616972">/*</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">48</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* if request is to read from zero offset, reset iterator to first</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">49</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">* record as it might have been already advanced by previous requests</span></div></div><div class="ec-line" style="--ecIndent:5ch"><div class="gutter"><div class="ln" aria-hidden="true">50</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">     </span></span><span style="--0:#99A0A6;--1:#616972">*/</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">51</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (iocb->ki_pos </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">52</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->index </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">53</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">54</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">55</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">56</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">    </span></span><span style="--0:#99A0A6;--1:#616972">/* Don't assume ki_pos is where we left it */</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">57</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">unlikely</span><span style="--0:#E1E4E8;--1:#24292E">(iocb->ki_pos </span><span style="--0:#F97583;--1:#BF3441">!=</span><span style="--0:#E1E4E8;--1:#24292E"> m->read_pos)) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">58</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// because our record position doesn't match the required position</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">59</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// it's likely because user want to read from a discrete position</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">60</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// so we need to re-find/reach to that position from beginning by calling traverse</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">61</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> ((err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">traverse</span><span style="--0:#E1E4E8;--1:#24292E">(m, iocb->ki_pos)) </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">EAGAIN)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">62</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">63</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (err) {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">64</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">            </span></span><span style="--0:#99A0A6;--1:#616972">/* With prejudice... */</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">65</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->read_pos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">66</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->index </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">67</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">68</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Done;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">69</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">} </span><span style="--0:#F97583;--1:#BF3441">else</span><span style="--0:#E1E4E8;--1:#24292E"> {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">70</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->read_pos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> iocb->ki_pos;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">71</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">72</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">73</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">74</div></div><div class="code"><span class="indent"><span style="--0:#99A0A6;--1:#616972">    </span></span><span style="--0:#99A0A6;--1:#616972">/* grab buffer if we didn't have one */</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">75</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">76</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->buf </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_buf_alloc</span><span style="--0:#E1E4E8;--1:#24292E">(m->size </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> PAGE_SIZE);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">77</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">78</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Enomem;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">79</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">80</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// something left in the buffer - copy it out first</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">81</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (m->count) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">82</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">n </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">copy_to_iter</span><span style="--0:#E1E4E8;--1:#24292E">(m->buf </span><span style="--0:#F97583;--1:#BF3441">+</span><span style="--0:#E1E4E8;--1:#24292E"> m->from, m->count, iter);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">83</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">-=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">84</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// update start from position for next read(if still something remaining)</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">85</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->from </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">86</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">copied </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">87</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (m->count)</span><span style="--0:#99A0A6;--1:#616972">   // hadn't managed to copy everything</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">88</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Done;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">89</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">90</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// get a non-empty record in the buffer</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">91</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->from </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">92</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">start</span><span style="--0:#E1E4E8;--1:#24292E">(m, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">93</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// then fetch one non-empty item into buffer</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">94</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">95</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">PTR_ERR</span><span style="--0:#E1E4E8;--1:#24292E">(p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">96</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">IS_ERR</span><span style="--0:#E1E4E8;--1:#24292E">(p))</span><span style="--0:#99A0A6;--1:#616972">    // EOF or an error</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">97</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">98</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">show</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">99</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (err </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">)</span><span style="--0:#99A0A6;--1:#616972">        // hard error</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">100</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">101</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">unlikely</span><span style="--0:#E1E4E8;--1:#24292E">(err))</span><span style="--0:#99A0A6;--1:#616972">  // ->show() says "skip it"</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">102</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">103</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">unlikely</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->count)) {</span><span style="--0:#99A0A6;--1:#616972"> // empty record</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">104</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">next</span><span style="--0:#E1E4E8;--1:#24292E">(m, p, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">105</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">continue</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">106</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">107</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#B392F0;--1:#6F42C1">seq_has_overflowed</span><span style="--0:#E1E4E8;--1:#24292E">(m))</span><span style="--0:#99A0A6;--1:#616972"> // got it</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">108</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Fill;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">109</div></div><div class="code"><span class="indent">        </span><span style="--0:#99A0A6;--1:#616972">// need a bigger buffer</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">110</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op-></span><span style="--0:#B392F0;--1:#6F42C1">stop</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">111</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">kvfree</span><span style="--0:#E1E4E8;--1:#24292E">(m->buf);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">112</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">113</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->buf </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_buf_alloc</span><span style="--0:#E1E4E8;--1:#24292E">(m->size </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">114</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">m->buf)</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">115</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Enomem;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">116</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">start</span><span style="--0:#E1E4E8;--1:#24292E">(m, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">117</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">118</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// EOF or an error</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">119</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op-></span><span style="--0:#B392F0;--1:#6F42C1">stop</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">120</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">121</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Done;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">122</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">Fill:</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">123</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// one non-empty record is in the buffer; if they want more,</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">124</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// try to fit more in, but in any case we need to advance</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">125</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// the iterator once for every record shown.</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">126</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#79B8FF;--1:#005CC5">1</span><span style="--0:#E1E4E8;--1:#24292E">) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">127</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">size_t</span><span style="--0:#E1E4E8;--1:#24292E"> offs </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->count;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">128</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">loff_t</span><span style="--0:#E1E4E8;--1:#24292E"> pos </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->index;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">129</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">130</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">next</span><span style="--0:#E1E4E8;--1:#24292E">(m, p, </span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->index);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">131</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (pos </span><span style="--0:#F97583;--1:#BF3441">==</span><span style="--0:#E1E4E8;--1:#24292E"> m->index) {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">132</div></div><div class="code"><span class="indent">            </span><span style="--0:#B392F0;--1:#6F42C1">pr_info_ratelimited</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#9ECBFF;--1:#032F62">"buggy .next function </span><span style="--0:#79B8FF;--1:#005CC5">%p</span><span style="--0:#9ECBFF;--1:#032F62">s did not update position index</span><span style="--0:#79B8FF;--1:#005CC5">\n</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">,</span></div></div><div class="ec-line" style="--ecIndent:24ch"><div class="gutter"><div class="ln" aria-hidden="true">133</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">                        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op->next);</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">134</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->index</span><span style="--0:#F97583;--1:#BF3441">++</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">135</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">136</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">p </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">IS_ERR</span><span style="--0:#E1E4E8;--1:#24292E">(p))</span><span style="--0:#99A0A6;--1:#616972">    // no next record for us</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">137</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">138</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (m->count </span><span style="--0:#F97583;--1:#BF3441">>=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">iov_iter_count</span><span style="--0:#E1E4E8;--1:#24292E">(iter))</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">139</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">140</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->op-></span><span style="--0:#B392F0;--1:#6F42C1">show</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">141</div></div><div class="code"><span class="indent">        </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (err </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E">) {</span><span style="--0:#99A0A6;--1:#616972">      // ->show() says "skip it"</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">142</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> offs;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">143</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">} </span><span style="--0:#F97583;--1:#BF3441">else</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (err </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">seq_has_overflowed</span><span style="--0:#E1E4E8;--1:#24292E">(m)) {</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">144</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">            </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> offs;</span></div></div><div class="ec-line" style="--ecIndent:12ch"><div class="gutter"><div class="ln" aria-hidden="true">145</div></div><div class="code"><span class="indent">            </span><span style="--0:#F97583;--1:#BF3441">break</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">146</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">147</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">148</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->op-></span><span style="--0:#B392F0;--1:#6F42C1">stop</span><span style="--0:#E1E4E8;--1:#24292E">(m, p);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">149</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972">// feed the request from buffer</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">150</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">n </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">copy_to_iter</span><span style="--0:#E1E4E8;--1:#24292E">(m->buf, m->count, iter);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">151</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">copied </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">152</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->count </span><span style="--0:#F97583;--1:#BF3441">-=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">153</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">m->from </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">154</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">Done:</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">155</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (</span><span style="--0:#B392F0;--1:#6F42C1">unlikely</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">!</span><span style="--0:#E1E4E8;--1:#24292E">copied)) {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">156</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">copied </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> m->count </span><span style="--0:#F97583;--1:#BF3441">?</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">EFAULT </span><span style="--0:#F97583;--1:#BF3441">:</span><span style="--0:#E1E4E8;--1:#24292E"> err;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">157</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">} </span><span style="--0:#F97583;--1:#BF3441">else</span><span style="--0:#E1E4E8;--1:#24292E"> {</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">158</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">iocb->ki_pos </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> copied;</span></div></div><div class="ec-line" style="--ecIndent:8ch"><div class="gutter"><div class="ln" aria-hidden="true">159</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">m->read_pos </span><span style="--0:#F97583;--1:#BF3441">+=</span><span style="--0:#E1E4E8;--1:#24292E"> copied;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">160</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">161</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">mutex_unlock</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#F97583;--1:#BF3441">&#x26;</span><span style="--0:#E1E4E8;--1:#24292E">m->lock);</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">162</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">return</span><span style="--0:#E1E4E8;--1:#24292E"> copied;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">163</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">Enomem:</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">164</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">err </span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-</span><span style="--0:#E1E4E8;--1:#24292E">ENOMEM;</span></div></div><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln" aria-hidden="true">165</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">goto</span><span style="--0:#E1E4E8;--1:#24292E"> Done;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">166</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">167</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">EXPORT_SYMBOL</span><span style="--0:#E1E4E8;--1:#24292E">(seq_read_iter);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** *  seq_read -  ->read() method for sequential files. *  @file: the file to read from *  @buf: the buffer to read to *  @size: the maximum number of bytes to read *  @ppos: the current position in the file * *  Ready-made ->f_op->read() */ssize_t seq_read(struct file *file, char __user *buf, size_t size, loff_t *ppos){    // construct a iov request from one-time read    struct iovec iov = { .iov_base = buf, .iov_len = size};    struct kiocb kiocb;    struct iov_iter iter;    ssize_t ret;    init_sync_kiocb(&#x26;kiocb, file);    iov_iter_init(&#x26;iter, ITER_DEST, &#x26;iov, 1, size);    kiocb.ki_pos = *ppos;    // enter real read function    ret = seq_read_iter(&#x26;kiocb, &#x26;iter);    *ppos = kiocb.ki_pos;    return ret;}EXPORT_SYMBOL(seq_read);/* * Ready-made ->f_op->read_iter() */ssize_t seq_read_iter(struct kiocb *iocb, struct iov_iter *iter){    struct seq_file *m = iocb->ki_filp->private_data;    size_t copied = 0;    size_t n;    void *p;    int err = 0;    // if request to read 0 byte    if (!iov_iter_count(iter))        return 0;    // make sure only one thread enter    mutex_lock(&#x26;m->lock);    /*     * if request is to read from zero offset, reset iterator to first     * record as it might have been already advanced by previous requests     */    if (iocb->ki_pos == 0) {        m->index = 0;        m->count = 0;    }    /* Don&#x27;t assume ki_pos is where we left it */    if (unlikely(iocb->ki_pos != m->read_pos)) {        // because our record position doesn&#x27;t match the required position        // it&#x27;s likely because user want to read from a discrete position        // so we need to re-find/reach to that position from beginning by calling traverse        while ((err = traverse(m, iocb->ki_pos)) == -EAGAIN)            ;        if (err) {            /* With prejudice... */            m->read_pos = 0;            m->index = 0;            m->count = 0;            goto Done;        } else {            m->read_pos = iocb->ki_pos;        }    }    /* grab buffer if we didn&#x27;t have one */    if (!m->buf) {        m->buf = seq_buf_alloc(m->size = PAGE_SIZE);        if (!m->buf)            goto Enomem;    }    // something left in the buffer - copy it out first    if (m->count) {        n = copy_to_iter(m->buf + m->from, m->count, iter);        m->count -= n;        // update start from position for next read(if still something remaining)        m->from += n;        copied += n;        if (m->count)   // hadn&#x27;t managed to copy everything            goto Done;    }    // get a non-empty record in the buffer    m->from = 0;    p = m->op->start(m, &#x26;m->index);    // then fetch one non-empty item into buffer    while (1) {        err = PTR_ERR(p);        if (!p || IS_ERR(p))    // EOF or an error            break;        err = m->op->show(m, p);        if (err < 0)        // hard error            break;        if (unlikely(err))  // ->show() says &#x22;skip it&#x22;            m->count = 0;        if (unlikely(!m->count)) { // empty record            p = m->op->next(m, p, &#x26;m->index);            continue;        }        if (!seq_has_overflowed(m)) // got it            goto Fill;        // need a bigger buffer        m->op->stop(m, p);        kvfree(m->buf);        m->count = 0;        m->buf = seq_buf_alloc(m->size <<= 1);        if (!m->buf)            goto Enomem;        p = m->op->start(m, &#x26;m->index);    }    // EOF or an error    m->op->stop(m, p);    m->count = 0;    goto Done;Fill:    // one non-empty record is in the buffer; if they want more,    // try to fit more in, but in any case we need to advance    // the iterator once for every record shown.    while (1) {        size_t offs = m->count;        loff_t pos = m->index;        p = m->op->next(m, p, &#x26;m->index);        if (pos == m->index) {            pr_info_ratelimited(&#x22;buggy .next function %ps did not update position index\n&#x22;,                        m->op->next);            m->index++;        }        if (!p || IS_ERR(p))    // no next record for us            break;        if (m->count >= iov_iter_count(iter))            break;        err = m->op->show(m, p);        if (err > 0) {      // ->show() says &#x22;skip it&#x22;            m->count = offs;        } else if (err || seq_has_overflowed(m)) {            m->count = offs;            break;        }    }    m->op->stop(m, p);    // feed the request from buffer    n = copy_to_iter(m->buf, m->count, iter);    copied += n;    m->count -= n;    m->from = n;Done:    if (unlikely(!copied)) {        copied = m->count ? -EFAULT : err;    } else {        iocb->ki_pos += copied;        m->read_pos += copied;    }    mutex_unlock(&#x26;m->lock);    return copied;Enomem:    err = -ENOMEM;    goto Done;}EXPORT_SYMBOL(seq_read_iter);"><div></div></button></div></figure></div>
<h2 id="more-ref"><a class="not-prose" href="#more-ref">more ref</a></h2>
<p>可以参考 <a href="https://www.cnblogs.com/embedded-linux/p/9751995.html" rel="noreferrer noopener" target="_blank">https://www.cnblogs.com/embedded-linux/p/9751995.html</a></p>   </div> </div> </article> <button class="hover:border-link fixed end-4 bottom-8 z-90 flex h-10 w-10 translate-y-28 cursor-pointer items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all transition-discrete duration-300 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 sm:end-8 sm:h-12 sm:w-12 dark:bg-zinc-700" data-show="false" id="to-top-btn"> <span class="sr-only">Back to top</span> <svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top font-semibold text-gray-600 sm:flex-row sm:justify-between sm:text-xs dark:text-gray-400"> <div class="me-0 text-neutral-400 sm:me-4">
&copy; <span class="text-accent">Eritque Arcus</span> 2020-2025.<br> <span>Powered by <a href="https://astro.build" class="hover:text-gray-700 dark:hover:text-gray-200">Astro</a> & modified <a href="https://github.com/chrismwilliams/astro-theme-cactus" class="hover:text-gray-700 dark:hover:text-gray-200">cactus</a></span><br> <a href="https://icp.gov.moe/?keyword=20222242" class="flex justify-center gap-1 text-xs hover:text-gray-700 dark:hover:text-gray-200"> <img src="/images/moe-icon120.png" class="h-4 w-4" alt="萌ICP备图标">
萌ICP备20222242号
</a> </div> <nav aria-labelledby="footer_links" class="flex flex-wrap gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"> <p id="footer_links" class="sr-only">More on this site</p> <a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/archive/"> Archive </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/about/"> About </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/math-notes/"> Notes </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/ctf-cheatsheet/"> CTF-QuickRef </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/music/"> Music </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="https://photos.ikuyo.dev"> Photos </a> <a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="https://www.travellings.cn/go.html"> 开往 </a> </nav> <script defer src="https://4-um4m1.ikuyo.dev/script.js" data-website-id="34e0a647-a8e8-40a8-ad62-742e9d604413" data-domains="ikuyo.dev"></script> <script type="text/javascript">
		(() => {
			const name = "outbound-link-click";
			document.querySelectorAll("a").forEach((a) => {
				if (a.host !== window.location.host && !a.getAttribute("data-umami-event")) {
					a.setAttribute("data-umami-event", name);
					a.setAttribute("data-umami-event-url", a.href);
				}
			});
		})();
	</script> </footer> </body></html> <script type="module">const e=document.getElementById("to-top-btn"),n=document.getElementById("blog-hero");function c(t){t.forEach(o=>{e.dataset.show=(!o.isIntersecting).toString()})}e.addEventListener("click",()=>{document.documentElement.scrollTo({behavior:"smooth",top:0})});const r=new IntersectionObserver(c);r.observe(n);</script>