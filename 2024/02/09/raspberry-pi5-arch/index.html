<!DOCTYPE html><html class="scroll-smooth" lang="zh-CN"> <head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1.0" name="viewport"><title>Raspberry Pi 5 安装 Arch Linux • Eritque Arcus</title><link rel="icon" href="/favicon.png" type="image/png"><link href="/manifest.webmanifest" rel="manifest"><link href="https://ikuyo.dev/2024/02/09/raspberry-pi5-arch/" rel="canonical"><meta content="Raspberry Pi 5 安装 Arch Linux • Eritque Arcus" name="title"><meta content="> 最近买的 Pimoroni 的 Nvme SSD 板到了, 就开始往上装 Arch> 因为我没有 Micro HD" name="description"><meta content="Eritque Arcus" name="author"><meta content="article" property="og:type"><meta content="Raspberry Pi 5 安装 Arch Linux" property="og:title"><meta content="> 最近买的 Pimoroni 的 Nvme SSD 板到了, 就开始往上装 Arch> 因为我没有 Micro HD" property="og:description"><meta content="https://ikuyo.dev/2024/02/09/raspberry-pi5-arch/" property="og:url"><meta content="Eritque Arcus" property="og:site_name"><meta content="zh_CN" property="og:locale"><meta content="1200" property="og:image:width"><meta content="630" property="og:image:height"><meta content="Eritque Arcus" property="article:author"><meta content="2024-02-09T18:22:31.000Z" property="article:published_time"><meta content="summary_large_image" property="twitter:card"><meta content="https://ikuyo.dev/2024/02/09/raspberry-pi5-arch/" property="twitter:url"><meta content="Raspberry Pi 5 安装 Arch Linux" property="twitter:title"><meta content="> 最近买的 Pimoroni 的 Nvme SSD 板到了, 就开始往上装 Arch> 因为我没有 Micro HD" property="twitter:description"><link href="/sitemap-index.xml" rel="sitemap"><link href="/rss.xml" title="Blog" rel="alternate" type="application/rss+xml"><link href="/notes/rss.xml" title="Notes" rel="alternate" type="application/rss+xml"><link href="https://webmention.io/ikuyo.dev/webmention" rel="webmention"><meta content="Astro v5.6.2" name="generator"><link href="https://github.com/Nambers" rel="me"><link rel="stylesheet" href="/_astro/_page_.B0l-nKfP.css"><script type="module" src="/_astro/page.V2R8AmkL.js"></script></head> <body class="bg-global-bg text-global-text mx-auto flex min-h-screen max-w-7xl flex-col px-4 pt-16 font-mono text-sm font-normal antialiased sm:px-8"> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "light" : "dark");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "light" : "dark"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-28 flex w-full items-center sm:ps-20" id="main-header"> <div class="flex w-full sm:flex-col"> <div class="flex w-full items-center sm:relative sm:inline-block"> <a aria-current="false" class="inline-flex items-center sm:relative sm:inline-block" href="/"> <img src="/avatar.png" alt="Avatar" class="me-3 h-16 w-16 rounded-full sm:absolute sm:-start-18 sm:me-0 sm:h-16 sm:w-16"> <span class="font-display text-accent ps-3 text-4xl font-bold tracking-wide whitespace-nowrap dark:drop-shadow-[0_0_2px_white] dark:drop-shadow-[0_0_4px_cyan] dark:drop-shadow-[0_0_8px_cyan] dark:drop-shadow-[0_0_16px_rgba(0,255,255,0.5)]"> Eritque Arcus </span> </a> </div> <nav aria-label="Main menu" class="bg-global-bg/85 absolute -inset-x-4 top-14 hidden w-full flex-col items-end gap-y-4 rounded-md py-4 shadow backdrop-blur-sm group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:rounded-none sm:bg-transparent sm:py-0 sm:ps-4 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <div class="text-accent sm:divide-accent sm:divide-x"> <a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/archive/"> Archive </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/about/"> About </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/math-notes/"> Notes </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/friends/"> Friends </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/ctf-cheatsheet/"> CTF-QuickRef </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="/music/"> Music </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="https://photos.ikuyo.dev"> Photos </a><a aria-current="false" class="px-2 py-2 underline-offset-2 hover:underline sm:py-0" data-astro-prefetch href="https://www.travellings.cn/go.html"> 开往 </a> </div> <div class="flex sm:ps-28"> <site-search class="ms-auto" id="search"> <button class="hover:text-accent flex h-9 w-9 cursor-pointer items-center justify-center rounded-md" aria-keyshortcuts="Control+K Meta+K" data-open-modal disabled> <svg aria-hidden="true" class="h-7 w-7" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" stroke="none"></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path> </svg> <span class="sr-only">Open Search</span> </button> <dialog aria-label="search" class="bg-global-bg h-full max-h-full w-full max-w-full border border-zinc-400 shadow-sm backdrop:backdrop-blur-sm open:flex sm:mx-auto sm:mt-16 sm:mb-auto sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md"> <div class="dialog-frame flex grow flex-col gap-4 p-6 pt-12 sm:pt-6"> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal>Close</button> <div class="search-container"> <div id="cactus__search"></div> </div> </div> </dialog> </site-search> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.fEYUxNp8.js"></script> <theme-toggle class="ms-2 sm:ms-4"> <button class="hover:text-accent relative h-9 w-9 cursor-pointer rounded-md p-2" type="button"> <span class="sr-only">Dark Theme</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0" fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100" fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path> <path d="M19 11h2m-1 -1v2"></path> </svg> </button> </theme-toggle> <script type="module" src="/_astro/ThemeToggle.astro_astro_type_script_index_0_lang.C1tldoqx.js"></script> </div> </nav> </div> <mobile-button class="mb-15"> <button aria-expanded="false" aria-haspopup="menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <span class="sr-only">Open main menu</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="text-accent absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header> <script type="module" src="/_astro/Header.astro_astro_type_script_index_0_lang.DuSsDY4R.js"></script> <main id="main">  <article class="grow break-words" data-pagefind-body> <div id="blog-hero" class="mb-12"><h1 class="title"> Raspberry Pi 5 安装 Arch Linux </h1> <div class="flex flex-wrap items-center gap-x-3 gap-y-2"> <p class="font-semibold"> <time datetime="2024-02-09T18:22:31.000Z" title="2024-02-09T18:22:31.000Z">9 February 2024</time> /  9 min read </p>  </div> <div class="mt-2"> <svg aria-hidden="true" class="inline-block h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> <span class="contents"> <a class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag:raspberry pi5" href="/tags/raspberry pi5/"><span class="sr-only">View more blogs with the tag&nbsp;</span>raspberry pi5 </a>,  </span> <span class="contents"> <a class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag:arch" href="/tags/arch/"><span class="sr-only">View more blogs with the tag&nbsp;</span>arch </a> </span>  </div></div> <div class="grid grid-cols-[1fr_auto] gap-10 lg:flex-row lg:items-start"> <details open class="lg:sticky lg:top-12 lg:order-2 lg:-me-32 lg:basis-64"> <summary class="title hover:marker:text-accent cursor-pointer text-lg">Table of Contents</summary> <nav class="ms-4 lg:w-full"> <ol class="mt-4"> <li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#0-准备"><span aria-hidden="true" class="me-0.5">#</span>0. 准备</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#1-刷-usb-boot"><span aria-hidden="true" class="me-0.5">#</span>1. 刷 USB Boot</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#2-usb-boot-准备"><span aria-hidden="true" class="me-0.5">#</span>2. USB Boot 准备</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#3-配置-nvme"><span aria-hidden="true" class="me-0.5">#</span>3. 配置 nvme</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#4-安装-arch"><span aria-hidden="true" class="me-0.5">#</span>4. 安装 Arch</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#5-配置-arch"><span aria-hidden="true" class="me-0.5">#</span>5. 配置 Arch</a> <ol> <li class="ms-2"> <a class="line-clamp-2 hover:text-accent mt-2 text-xs" href="#troubleshooting"><span aria-hidden="true" class="me-0.5">#</span>Troubleshooting</a>  </li> </ol> </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#6-可选-cloudflare-公网-ssh"><span aria-hidden="true" class="me-0.5">#</span>6. [可选] Cloudflare 公网 SSH</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#7-可选-gui"><span aria-hidden="true" class="me-0.5">#</span>7. [可选] GUI</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#8-可选-更新-bootloader"><span aria-hidden="true" class="me-0.5">#</span>8. [可选] 更新 Bootloader</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#9-boot-还是-bootfirmware"><span aria-hidden="true" class="me-0.5">#</span>9. /boot 还是 /boot/firmware?</a>  </li><li class> <a class="line-clamp-2 hover:text-accent mt-3" href="#一些可能的-raspberry-pi-应用面"><span aria-hidden="true" class="me-0.5">#</span>一些可能的 Raspberry Pi 应用面</a> <ol> <li class="ms-2"> <a class="line-clamp-2 hover:text-accent mt-2 text-xs" href="#wifi-无线中继"><span aria-hidden="true" class="me-0.5">#</span>WIFI 无线中继</a>  </li><li class="ms-2"> <a class="line-clamp-2 hover:text-accent mt-2 text-xs" href="#github-self-hosted-runner"><span aria-hidden="true" class="me-0.5">#</span>GitHub self hosted runner</a>  </li><li class="ms-2"> <a class="line-clamp-2 hover:text-accent mt-2 text-xs" href="#self-hosted-website-analytics"><span aria-hidden="true" class="me-0.5">#</span>self hosted website analytics</a>  </li><li class="ms-2"> <a class="line-clamp-2 hover:text-accent mt-2 text-xs" href="#self-hosted-password-manager"><span aria-hidden="true" class="me-0.5">#</span>self hosted password manager</a>  </li> </ol> </li> </ol> </nav> </details> <div class="prose max-w-none prose-sm prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-gray-600 prose-headings:hover:before:text-accent sm:prose-headings:before:content-['#'] sm:prose-th:before:content-none">  <blockquote>
<p>最近买的 Pimoroni 的 Nvme SSD 板到了, 就开始往上装 Arch<br>
因为我没有 Micro HDMI 的线和读写 SSD 的工具, 就打算和正常装系统一样用个 usb boot 进去里面装,同时也得一直 Headless</p>
</blockquote>
<h2 id="0-准备"><a class="not-prose" href="#0-准备">0. 准备</a></h2>
<ul>
<li>Raspberry Pi 5</li>
<li>USB</li>
<li>网线</li>
<li>PC</li>
<li>SSD</li>
</ul>
<h2 id="1-刷-usb-boot"><a class="not-prose" href="#1-刷-usb-boot">1. 刷 USB Boot</a></h2>
<p>用 <code>sudo pacman -S rpi-imager</code> 下载 <code>rpi-imager</code> 然后往 USB 里刷一个 <code>Raspberry OS</code> 然后配置好 SSH 密码</p>
<h2 id="2-usb-boot-准备"><a class="not-prose" href="#2-usb-boot-准备">2. USB Boot 准备</a></h2>
<ol start="0">
<li>把 USB 插到 Pi 5 上</li>
<li>把网线从 Pi 上连到 PC, 然后进设置把类型改成 <code>share with other computer</code> <img src="/images/rpi5-arch1.png" alt="share with other computer option"></li>
<li>用 <code>ip a</code> 拿到 PC 有线的 ip 比如 <code>10.42.0.1</code>, 然后用 <code>nmap -sn 10.42.0.0/24</code>(没有 <code>nmap</code> 就装) 扫 Pi 的 ip (比如我这里是 <code>10.42.0.83</code>)
<img src="/images/rpi5-arch2.png" alt="ip a">
<img src="/images/rpi5-arch3.png" alt="nmap"></li>
<li><code>ssh alarm@10.42.0.83</code> 和前面设的密码连接</li>
<li><code>sudo apt-get update &#x26;&#x26; sudo apt-get upgrade</code> 更新一下系统<br>
如果通过网线出不了网可能是 <code>dhcpcd</code>, <code>iptable</code> 之类的问题</li>
<li><code>sudo rpi-eeprom-config -e</code> 里改 <code>BOOT_ORDER</code>, 比如 <code>BOOT_ORDER=0xf64</code> 就是先尝试加载 <code>USB</code> (<code>4</code>) 然后 <code>nvme</code> (<code>6</code>) 然后重复 (<code>f</code>). 参考<a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html#BOOT_ORDER" rel="noreferrer noopener" target="_blank">raspberrypi.com/documentation/computers/raspberry-pi.html#BOOT_ORDER</a></li>
<li><code>sudo rpi-eeprom-update -a</code> 更新一下固件</li>
</ol>
<h2 id="3-配置-nvme"><a class="not-prose" href="#3-配置-nvme">3. 配置 nvme</a></h2>
<p>参考 <a href="https://shop.pimoroni.com/products/nvme-base?variant=41219587178579" rel="noreferrer noopener" target="_blank">pimoroni</a>, 基本除了更新 pi 的固件不需要配置, 如果 <code>lsblk</code> 看不到 SSD 可能是要重启</p>
<h2 id="4-安装-arch"><a class="not-prose" href="#4-安装-arch">4. 安装 Arch</a></h2>
<ol start="0">
<li>进 USB boot 的 SSH</li>
<li>分盘, 我一般用 <code>cfdisk</code> 分(比如 <code>sudo cfdisk /dev/nvme0n1</code>), 最少分两个盘, 一个 <code>>=300Mb</code> 的 boot 和一个主盘’</li>
<li>用 <code>sudo apt install libarchive-tools</code> 来安装 <code>bsdtar</code></li>
<li>用 <code>root</code> 运行以下脚本(建议写到一个脚本文件里然后<code>sudo</code>), 脚本来自 <a href="https://kiljan.org/2023/11/24/arch-linux-arm-on-a-raspberry-pi-5-model-b/" rel="noreferrer noopener" target="_blank">kiljan.org/2023/11/24/arch-linux-arm-on-a-raspberry-pi-5-model-b</a><br>
执行前要去找新的下载链接(见注释)
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.u71jf.css"><script type="module" src="/_astro/ec.8zarh.js"></script><figure class="frame"><figcaption class="header"></figcaption><pre data-language="bash" class="wrap" style="--ecMaxLine:91ch"><code><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972">#!/bin/bash</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972"># SSD 的路径</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> SDDEV</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">/dev/nvme0n1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> SDPARTBOOT</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">/dev/nvme0n1p1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> SDPARTROOT</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">/dev/nvme0n1p2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> SDMOUNT</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">/mnt/sd</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> DOWNLOADDIR</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">/tmp/pi</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> DISTURL</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"http://os.archlinuxarm.org/os/ArchLinuxARM-rpi-aarch64-latest.tar.gz"</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> $DOWNLOADDIR</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">cd</span><span style="--0:#E1E4E8;--1:#24292E"> $DOWNLOADDIR &#x26;&#x26; </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-JLO</span><span style="--0:#E1E4E8;--1:#24292E"> $DISTURL</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972"># 已经分过盘了</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972">#sfdisk --quiet --wipe always $SDDEV &#x3C;&#x3C; EOF</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972">#,256M,0c,</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972">#,,,</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972">#EOF</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkfs.vfat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-F</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">32</span><span style="--0:#E1E4E8;--1:#24292E"> $SDPARTBOOT</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkfs.ext4</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-E</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">lazy_itable_init=0,lazy_journal_init=</span><span style="--0:#79B8FF;--1:#005CC5">0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-F</span><span style="--0:#E1E4E8;--1:#24292E"> $SDPARTROOT</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> $SDMOUNT</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mount</span><span style="--0:#E1E4E8;--1:#24292E"> $SDPARTROOT $SDMOUNT</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> ${SDMOUNT}</span><span style="--0:#9ECBFF;--1:#032F62">/boot/firmware</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mount</span><span style="--0:#E1E4E8;--1:#24292E"> $SDPARTBOOT ${SDMOUNT}</span><span style="--0:#9ECBFF;--1:#032F62">/boot/firmware</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">bsdtar</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-xpf</span><span style="--0:#E1E4E8;--1:#24292E"> ${DOWNLOADDIR}</span><span style="--0:#9ECBFF;--1:#032F62">/ArchLinuxARM-rpi-aarch64-latest.tar.gz</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-C</span><span style="--0:#E1E4E8;--1:#24292E"> $SDMOUNT</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">rm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-rf</span><span style="--0:#E1E4E8;--1:#24292E"> ${SDMOUNT}</span><span style="--0:#9ECBFF;--1:#032F62">/boot/</span><span style="--0:#79B8FF;--1:#005CC5">*</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">mkdir</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> ${DOWNLOADDIR}</span><span style="--0:#9ECBFF;--1:#032F62">/linux-rpi</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">pushd ${DOWNLOADDIR}/linux-rpi</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972"># 这里需要自己去找链接, 不然可能 404</span></div></div><div class="ec-line"><div class="code"><span style="--0:#99A0A6;--1:#616972"># 去 https://archlinuxarm.org/packages/aarch64/linux-rpi 然后复制下载链接</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-JLO</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http://mirror.archlinuxarm.org/aarch64/core/linux-rpi-6.6.16-1-aarch64.pkg.tar.xz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">tar</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">*</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">cp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-rf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">boot/</span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#E1E4E8;--1:#24292E"> ${SDMOUNT}</span><span style="--0:#9ECBFF;--1:#032F62">/boot/firmware</span></div></div><div class="ec-line"><div class="code"><span style="--0:#E1E4E8;--1:#24292E">popd</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sync</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">umount</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-R</span><span style="--0:#E1E4E8;--1:#24292E"> $SDMOUNT</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#!/bin/bash# SSD 的路径export SDDEV=/dev/nvme0n1export SDPARTBOOT=/dev/nvme0n1p1export SDPARTROOT=/dev/nvme0n1p2export SDMOUNT=/mnt/sdexport DOWNLOADDIR=/tmp/piexport DISTURL=&#x22;http://os.archlinuxarm.org/os/ArchLinuxARM-rpi-aarch64-latest.tar.gz&#x22;mkdir -p $DOWNLOADDIR(cd $DOWNLOADDIR &#x26;&#x26; \curl -JLO $DISTURL)# 已经分过盘了#sfdisk --quiet --wipe always $SDDEV << EOF#,256M,0c,#,,,#EOFmkfs.vfat -F 32 $SDPARTBOOTmkfs.ext4 -E lazy_itable_init=0,lazy_journal_init=0 -F $SDPARTROOTmkdir -p $SDMOUNTmount $SDPARTROOT $SDMOUNTmkdir -p ${SDMOUNT}/boot/firmwaremount $SDPARTBOOT ${SDMOUNT}/boot/firmwarebsdtar -xpf ${DOWNLOADDIR}/ArchLinuxARM-rpi-aarch64-latest.tar.gz -C $SDMOUNTrm -rf ${SDMOUNT}/boot/*mkdir -p ${DOWNLOADDIR}/linux-rpipushd ${DOWNLOADDIR}/linux-rpi# 这里需要自己去找链接, 不然可能 404# 去 https://archlinuxarm.org/packages/aarch64/linux-rpi 然后复制下载链接curl -JLO http://mirror.archlinuxarm.org/aarch64/core/linux-rpi-6.6.16-1-aarch64.pkg.tar.xztar xf *cp -rf boot/* ${SDMOUNT}/boot/firmwarepopdsyncumount -R $SDMOUNT"><div></div></button></div></figure></div>
这里是 <code>/boot/firmware</code> 而不是 <code>/boot</code> 参考 <a href="https://www.raspberrypi.com/documentation/computers/configuration.html#the-boot-folder" rel="noreferrer noopener" target="_blank">raspberrypi.com/documentation/computers/configuration.html#the-boot-folder</a>.</li>
<li>挂载 SSD (可以写成脚本文件)
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="bash" class="wrap" style="--ecMaxLine:43ch"><code><div class="ec-line" style="--ecIndent:1ch"><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972">#!/bin/bash</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="code"><span class="indent"> </span><span style="--0:#B392F0;--1:#6F42C1">mount</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/nvme0n1p2</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/mnt/sd</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="code"><span class="indent"> </span><span style="--0:#B392F0;--1:#6F42C1">mount</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/nvme0n1p1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/mnt/sd/boot/firmware</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=" #!/bin/bash mount /dev/nvme0n1p2 /mnt/sd mount /dev/nvme0n1p1 /mnt/sd/boot/firmware"><div></div></button></div></figure></div>
</li>
<li>编辑 <code>sudo vim /mnt/sd/etc/fstab</code>, 改成你的盘
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="ini" class="wrap" style="--ecMaxLine:66ch"><code><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># Static information about the filesystems.</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># See fstab(5) for details.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code">
</div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># &#x3C;file system> &#x3C;dir> &#x3C;type> &#x3C;options> &#x3C;dump> &#x3C;pass></span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># &#x3C;pass> is the order of loading parition</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># main partition</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">7</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E"> </span></span><span style="--0:#E1E4E8;--1:#24292E">/dev/nvme0n1p2  /               ext4    defaults        0       1</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">8</div></div><div class="code"><span class="indent"> </span><span style="--0:#99A0A6;--1:#616972"># boot partition</span></div></div><div class="ec-line" style="--ecIndent:1ch"><div class="gutter"><div class="ln" aria-hidden="true">9</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E"> </span></span><span style="--0:#E1E4E8;--1:#24292E">/dev/nvme0n1p1  /boot/firmware  vfat    defaults        0       2</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=" # Static information about the filesystems. # See fstab(5) for details. # <file system> <dir> <type> <options> <dump> <pass> # <pass> is the order of loading parition # main partition /dev/nvme0n1p2  /               ext4    defaults        0       1 # boot partition /dev/nvme0n1p1  /boot/firmware  vfat    defaults        0       2"><div></div></button></div></figure></div>
</li>
<li>编辑 <code>sudo vim /mnt/sd/boot/firmware/cmdline.txt</code>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="ini" class="wrap" style="--ecMaxLine:130ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># root=/dev/nvme0n1p2 rootfstype=ext4 rw rootwait console=serial0,115200 console=tty1 fsck.repair=yes</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># root=UUID=0000-0000 rootfstype=ext4 rw rootwait console=serial0,115200 console=tty1 fsck.repair=yes</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">root</span><span style="--0:#E1E4E8;--1:#24292E">=</span><span style="--0:#F97583;--1:#BF3441">PARTUUID</span><span style="--0:#E1E4E8;--1:#24292E">=00000000-0000-0000-0000-000000000000 </span><span style="--0:#F97583;--1:#BF3441">rootfstype</span><span style="--0:#E1E4E8;--1:#24292E">=ext4 rw rootwait </span><span style="--0:#F97583;--1:#BF3441">console</span><span style="--0:#E1E4E8;--1:#24292E">=serial0,115200 </span><span style="--0:#F97583;--1:#BF3441">console</span><span style="--0:#E1E4E8;--1:#24292E">=tty1 </span><span style="--0:#F97583;--1:#BF3441">fsck.repair</span><span style="--0:#E1E4E8;--1:#24292E">=yes</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="# root=/dev/nvme0n1p2 rootfstype=ext4 rw rootwait console=serial0,115200 console=tty1 fsck.repair=yes# root=UUID=0000-0000 rootfstype=ext4 rw rootwait console=serial0,115200 console=tty1 fsck.repair=yesroot=PARTUUID=00000000-0000-0000-0000-000000000000 rootfstype=ext4 rw rootwait console=serial0,115200 console=tty1 fsck.repair=yes"><div></div></button></div></figure></div>
我这里用的是盘的 <code>PARTUUID</code>, 理论上用路径或UUID应该也可以, 通过 <code>ls /dev/disk/by-partuuid -al</code>, <code>ls /dev/disk/by-uuid -al</code> 和 <code>lsblk</code> 可以拿到</li>
<li>关机， 拔掉 USB, 重启</li>
</ol>
<h2 id="5-配置-arch"><a class="not-prose" href="#5-配置-arch">5. 配置 Arch</a></h2>
<ul>
<li>滚下系统</li>
<li>[可选] 加 SSH <code>~/.ssh/authorized_keys</code></li>
<li>同步下时间 <code>ntp</code></li>
<li>设置 <code>locale</code></li>
<li>[可选] 安装 <code>zsh</code> <code>omz</code></li>
<li>无线网络
<ul>
<li>安装 <code>NetworkManager</code>: <code>pacman -S NetworkManager</code>, <code>systemctl enable --now NetworkManager</code>
<ul>
<li>用 <code>nmtui</code> 启用 TUI 来配置</li>
</ul>
</li>
<li>或安装 <code>iwd</code> 来连接无线网: <code>pacman -S iwd</code>, <code>systemctl enable --now iwd</code>
<ul>
<li>用 <code>iwctl</code> 然后 <code>station wlan0 connect &#x3C;UID></code> 来连接</li>
<li><code>sudo systemctl enable --now iwd</code> 开机启动系统服务</li>
<li>编辑 <code>sudo vim /etc/iwd/main.conf</code>, 加入
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="ini" class="wrap" style="--ecMaxLine:31ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">[Settings]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">AutoConnect</span><span style="--0:#E1E4E8;--1:#24292E">=true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">[General]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">4</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">EnableNetworkConfiguration</span><span style="--0:#E1E4E8;--1:#24292E">=true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">[Network]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">6</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">EnableIPv6</span><span style="--0:#E1E4E8;--1:#24292E">=true</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="[Settings]AutoConnect=true[General]EnableNetworkConfiguration=true[Network]EnableIPv6=true"><div></div></button></div></figure></div>
来让 wifi 自动连接, 使用内置 <code>dhcph</code> 和 <code>ipv6</code></li>
</ul>
</li>
</ul>
</li>
<li>[可选?] 安装 <code>dhcph</code>
<ul>
<li><code>sudo systemctl enable --now dhcph</code></li>
<li>[可选?] 在 <code>/etc/dhcpcd.conf</code> 禁用 ipv6</li>
</ul>
</li>
<li>新建用户, 删除 alarm</li>
<li>改 <code>hostname</code> (默认是 <code>alarm</code>)</li>
<li>[可选] 安装 <code>linux-rpi-16k</code>
<ul>
<li>如果安装后一直 <code>boot</code> 进旧的 也就是 <code>linux-rpi</code> 内核, 可以试着用 <code>/boot/kernel8.img</code> 覆盖 <code>/boot/firmware/kernel8.img</code></li>
</ul>
</li>
<li>[可选] Arch 下的 <code>sudo pacman -S rpi5-eeprom</code> 来更新固件</li>
<li>[可选] 如果要修复 <code>pacman</code> 里生成 image 的
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="log" class="wrap" style="--ecMaxLine:85ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">==> </span><span style="--0:#FDAEB7;--1:#B31D28">WARNING</span><span style="--0:#E1E4E8;--1:#24292E">: errors were encountered during the build. The image may not be complete.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">error:</span><span style="--0:#E1E4E8;--1:#24292E"> command failed to execute correctly</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="==> WARNING: errors were encountered during the build. The image may not be complete.error: command failed to execute correctly"><div></div></button></div></figure></div>
可以编辑 <code>/etc/mkinitcpio.conf</code> 的 <code>HOOKS</code> 那一行, 去掉 <code>kms</code>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="ini" class="wrap" style="--ecMaxLine:87ch"><code><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># removed kms</span></div></div><div class="ec-line"><div class="gutter"><div class="ln" aria-hidden="true">2</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">HOOKS</span><span style="--0:#E1E4E8;--1:#24292E">=(base udev autodetect modconf keyboard keymap consolefont block filesystems fsck)</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="# removed kmsHOOKS=(base udev autodetect modconf keyboard keymap consolefont block filesystems fsck)"><div></div></button></div></figure></div>
参考 <a href="https://archlinuxarm.org/forum/viewtopic.php?f=15&#x26;t=16672&#x26;start=40#p72020" rel="noreferrer noopener" target="_blank">archlinuxarm</a></li>
</ul>
<h3 id="troubleshooting"><a class="not-prose" href="#troubleshooting">Troubleshooting</a></h3>
<p>如果遇到什么奇怪的内核问题, 比如安装了 16k page 的新内核但是一直在加载旧内核(表现为 <code>uname -a</code> 里和 <code>lsmod</code> 为空之类), 或者 <code>pacman -Syyu</code> 更新内核后有一些问题, 可能是因为内核的 <code>PKGBUILD</code> 里面装到 <code>/boot/kernel8.img</code> 去了(因为我看不到 Arch Linux ARM 的 <code>PKGBUILD</code> 文件所以不能确认). 可以试一下 <code>sudo cp /boot/kernel8.img /boot/firmware/kernel8.img</code> 来覆盖看看能不能修.</p>
<h2 id="6-可选-cloudflare-公网-ssh"><a class="not-prose" href="#6-可选-cloudflare-公网-ssh">6. [可选] Cloudflare 公网 SSH</a></h2>
<blockquote>
<p>因为 <code>cloudflare</code> 提供 <code>tunnel</code>, 我们可以用 <code>tunnel</code> 来做 Pi 的公网 SSH (以及其他要公网的服务, 相当于内网穿透)</p>
</blockquote>
<ol start="0">
<li>进 pi 的 arch 的 SSH</li>
<li>接下来可以用 docker 的 <code>cloudflared</code> 或者手动编译 (因为 <a href="https://github.com/cloudflare/cloudflared/issues/1151#issuecomment-1888738119" rel="noreferrer noopener" target="_blank">issue#1151</a> 提到在 <code>2024.1.0</code> 后要自己编译 <code>go</code> 标准库, 不然开不了通道), 我这里选的是手动编译</li>
<li>通过
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="bash" class="wrap" style="--ecMaxLine:46ch"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">git</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">clone</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://github.com/cloudflare/go.git</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">cd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">go/src</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">./make.bash</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="git clone https://github.com/cloudflare/go.gitcd go/src./make.bash"><div></div></button></div></figure></div>
编译 <code>cloudflare</code> 的 <code>go</code> 标准库</li>
<li>把 <code>go/bin/</code> 加到 <code>PATH</code> 里</li>
<li>通过
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="bash" class="wrap" style="--ecMaxLine:55ch"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">git</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">clone</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://github.com/cloudflare/cloudflared.git</span></div></div><div class="ec-line"><div class="code"><span style="--0:#79B8FF;--1:#005CC5">cd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cloudflared</span></div></div><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">make</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cloudflared</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="git clone https://github.com/cloudflare/cloudflared.gitcd cloudflaredmake cloudflared"><div></div></button></div></figure></div>
编译 <code>cloudflared</code></li>
<li>把 <code>cloudflared/</code> 加到 <code>PATH</code> 里</li>
<li>在 <code>cloudflare</code> 网页上创建一个 <code>tunnel</code><img src="/images/rpi5-arch4.png" alt="tunnel">然后在里面创建协议为 <code>SSH</code> 的 <code>public hostname</code></li>
<li>复制 <code>cloudflared</code> 网页上的 <code>tunnel</code> 配置, 比如
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre data-language="bash" class="wrap" style="--ecMaxLine:40ch"><code><div class="ec-line"><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">cloudflared</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;TOKEN></span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo cloudflared service install <TOKEN>"><div></div></button></div></figure></div>
</li>
<li><code>sudo systemctl enable --now cloudflared</code></li>
<li>然后在 pc 上安装 <code>sudo pacman -S cloudflared</code></li>
<li>在 <code>.ssh/config</code> 里写 <code>cloudflared</code> 的 <code>ProxyCommand</code> 为 <code>cloudflared access ssh --hostname %h</code>, 参考 <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/use-cases/ssh/#native-terminal" rel="noreferrer noopener" target="_blank">developers.cloudflare.com/cloudflare-one/connections/connect-networks/use-cases/ssh</a></li>
</ol>
<h2 id="7-可选-gui"><a class="not-prose" href="#7-可选-gui">7. [可选] GUI</a></h2>
<p>直接 Hyprland<br>
<em>注意是 <code>pacman -S hyprland</code> 和 <code>Hyprland</code> 启动, 大写 H</em></p>
<h2 id="8-可选-更新-bootloader"><a class="not-prose" href="#8-可选-更新-bootloader">8. [可选] 更新 Bootloader</a></h2>
<blockquote>
<p>如果风扇没有在开机后(温度不到)时自动关闭, 或者根本不启动，可能是因为 Bootloader 要更新</p>
</blockquote>
<ol start="0">
<li>AUR 里这个 <a href="https://aur.archlinux.org/packages/rpi-eeprom-git" rel="noreferrer noopener" target="_blank">rpi-eeprom-git</a> 应该过时了，我目前是手动安装的.</li>
<li>下载或者手动复制这个文件到本地 <a href="https://github.com/archlinuxarm/PKGBUILDs/blob/master/alarm/rpi-eeprom/PKGBUILD" rel="noreferrer noopener" target="_blank">PKGBUILD</a> 和 <a href="https://github.com/archlinuxarm/PKGBUILDs/blob/master/alarm/rpi-eeprom/rpi-eeprom.install" rel="noreferrer noopener" target="_blank">rpi-eeprom.install</a>.</li>
<li>把里面第四行 <code>pkgname=(rpi4-eeprom rpi5-eeprom)</code> 这里去掉一个不然 <code>conflicts</code> 会爆 (因为会试图安装两个包).</li>
<li>然后在目录下 <code>makepkg -si</code> 安装.</li>
<li>运行 <code>sudo rpi-eeprom-update</code>.</li>
<li>需要复制新的固件从 <code>/boot</code> 到 <code>/boot/firmware</code>, 比如 <code>sudo cp /boot/bcm2712-rpi-5-b.dtb /boot/firmware/bcm2712-rpi-5-b.dtb</code>, 具体名字是哪个可以用 <code>sudo vclog --msg</code> 看, 覆盖, 然后再重启一次</li>
</ol>
<h2 id="9-boot-还是-bootfirmware"><a class="not-prose" href="#9-boot-还是-bootfirmware">9. <code>/boot</code> 还是 <code>/boot/firmware</code>?</a></h2>
<p>从 <a href="https://github.com/raspberrypi/rpi-eeprom/blob/master/rpi-eeprom-update#L734" rel="noreferrer noopener" target="_blank">rpi-eeprom-update#L734</a> 来看, 优先级是先是 <code>/boot/firmware</code> 然后再是 <code>/boot</code>, 前面我们<code>3.5</code> <code>fstab</code> 挂载的也是 <code>/boot/firmware</code>.<br>
但是因为某些原因 (可能比如 pi 4 里默认是 <code>/boot</code>), 相当一部分系统更新, 比如 <a href="https://archlinuxarm.org/packages/aarch64/linux-rpi-16k" rel="noreferrer noopener" target="_blank">linux-rpi-16k</a>, 打包后还是解压到 <code>/boot</code> 里导致不能正确更新.<br>
所以我目前的暂时解决方法是:</p>
<ul>
<li>每次更新完系统 (<code>mkinitcpio</code> 跑后) 手动用 <code>sudo cp /boot/kernel8.img /boot/firmware/kernel8.img</code> 覆盖</li>
<li>每次更新完固件后 (通过 <code>rpi-eeprom-update</code>), 手动用 <code>sudo cp /boot/bcm2712-rpi-5-b.dtb /boot/firmware/bcm2712-rpi-5-b.dtb</code> 覆盖 (具体名字可能有变)</li>
</ul>
<p>或者应该也可以一开始通过用 <code>/boot</code> 而不是 <code>/boot/firmware</code> 来解决, 但是我目前 pi 5 是无头模式就懒得折腾重装系统了</p>
<h2 id="一些可能的-raspberry-pi-应用面"><a class="not-prose" href="#一些可能的-raspberry-pi-应用面">一些可能的 Raspberry Pi 应用面</a></h2>
<h3 id="wifi-无线中继"><a class="not-prose" href="#wifi-无线中继">WIFI 无线中继</a></h3>
<p>如果你和我一样(幸运得(x))买到一张板载 MEDIATEK 7927 的主板, 他从2024到2025一年多还没可用的驱动. 那么就可以用树莓派救急当作无限中继(普通路由器也有这个功能).</p>
<p>配置也非常简单, <code>nmtui</code> 修改连接, 然后修改 <code>wired connection</code> 有线连接里面 <code>ipv4</code> 从 <code>automatic</code> 到 <code>shared</code> 模式. 然后就可以通过网线共享无线网络</p>
<h3 id="github-self-hosted-runner"><a class="not-prose" href="#github-self-hosted-runner">GitHub self hosted runner</a></h3>
<p>见 <a href="https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/adding-self-hosted-runners" rel="noreferrer noopener" target="_blank">https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/adding-self-hosted-runners</a>, 配置就是跑一个脚本</p>
<h3 id="self-hosted-website-analytics"><a class="not-prose" href="#self-hosted-website-analytics">self hosted website analytics</a></h3>
<p>我是跑的 <a href="https://github.com/umami-software/umami" rel="noreferrer noopener" target="_blank">umami</a> 的 docker</p>
<h3 id="self-hosted-password-manager"><a class="not-prose" href="#self-hosted-password-manager">self hosted password manager</a></h3>
<p><a href="https://github.com/dani-garcia/vaultwarden" rel="noreferrer noopener" target="_blank">Vaultwarden</a></p>
<center>- 新年快乐 :) -</center>   </div> </div> </article> <button class="hover:border-link fixed end-4 bottom-8 z-90 flex h-10 w-10 translate-y-28 cursor-pointer items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all transition-discrete duration-300 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 sm:end-8 sm:h-12 sm:w-12 dark:bg-zinc-700" data-show="false" id="to-top-btn"> <span class="sr-only">Back to top</span> <svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top font-semibold text-gray-600 sm:flex-row sm:justify-between sm:text-xs dark:text-gray-400"> <div class="me-0 text-neutral-400 sm:me-4">
&copy; <span class="text-accent">Eritque Arcus</span> 2020-2025.<br> <span>Powered by <a href="https://astro.build" class="hover:text-black">Astro</a>|<a href="https://github.com/chrismwilliams/astro-theme-cactus" class="hover:text-black">cactus</a></span><br> <a href="https://icp.gov.moe/?keyword=20222242" class="flex justify-center gap-1 text-xs hover:text-black"> <img src="/images/moe-icon120.png" class="h-4 w-4" alt="萌ICP备图标">
萌ICP备20222242号
</a> </div> <nav aria-labelledby="footer_links" class="flex flex-wrap gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"> <p id="footer_links" class="sr-only">More on this site</p> <a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/archive/"> Archive </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/about/"> About </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/math-notes/"> Notes </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/friends/"> Friends </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/ctf-cheatsheet/"> CTF-QuickRef </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="/music/"> Music </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="https://photos.ikuyo.dev"> Photos </a><a class="hover:text-global-text px-4 py-2 hover:underline sm:py-0" href="https://www.travellings.cn/go.html"> 开往 </a> </nav> <script defer src="https://4-um4m1.ikuyo.dev/script.js" data-website-id="34e0a647-a8e8-40a8-ad62-742e9d604413" data-domains="ikuyo.dev"></script> <script type="text/javascript">
		(() => {
			const name = "outbound-link-click";
			document.querySelectorAll("a").forEach((a) => {
				if (a.host !== window.location.host && !a.getAttribute("data-umami-event")) {
					a.setAttribute("data-umami-event", name);
					a.setAttribute("data-umami-event-url", a.href);
				}
			});
		})();
	</script> </footer> </body></html> <script type="module">const e=document.getElementById("to-top-btn"),n=document.getElementById("blog-hero");function c(t){t.forEach(o=>{e.dataset.show=(!o.isIntersecting).toString()})}e.addEventListener("click",()=>{document.documentElement.scrollTo({behavior:"smooth",top:0})});const r=new IntersectionObserver(c);r.observe(n);</script>